#!/bin/bash

data=(
"/data"
)

file=$0

addData() {
    local top="$(head -n +3 $file)"
    local middle="$@"
    local bottom="$(tail -n +4 $file)"
    echo "$top"     > $file
    echo "$middle" >> $file
    echo "$bottom" >> $file
}

<< "addData()"
newData="\"\" \"\" \"\" \\"
addData $newData
addData()

notify() {
    zenity --notification --text="$1"
}

<< "notify()"
notify $file
notify()

listData() {
    local i=0
    list=()
    for elem in "${data[@]}"
    do
        if [ ! $(($i % 4)) -eq 0 ]
        then
            list+=("$elem")
        fi
        ((i++))
    done
}

<< "listData()"
listData
notify ${#list[@]}
listData()

createListWindow() {
    listData
    zenity --list                       \
           --radiolist\
           --title        "URL Manager" \
           --text         "List of Keys"\
           --column       ""\
           --column       Key           \
           --column       Description   \
           "${list[@]}"                 \
           --print-column ALL           \
           --cancel-label Back          \
           --ok-label     Remove        \
           --extra-button Add
}

update() {
    sleep 0.1s
    $file "updated"
}

<< "update()"
notify $1
button=$( createListWindow )
if [ $button = "Add" ]
then
    addData "FALSE" "\"https://www.google.com/\" \"G\" \"google\" \\" & update
fi
update()

dataIndex() {
    listData
    local i=0
    for elem in "${list[@]}"
    do
        if [ $(($i % 3)) -eq 1 ]
        then
            id="$elem"
        elif [ $(($i % 3)) -eq 2 ]
        then
            id+="|$elem"
            if [ "$id" = "$1" ]
            then
                echo $((($i + 10) / 3))
            fi
        fi
        ((i++))
    done
}

<< "dataIndex()"
id=$( createListWindow )
status=$?
if [ $status -eq 0 ]
then
    index=$( dataIndex $id )
    notify $index
fi
dataIndex()

removeData() {
    if [ $1 ]
    then
        echo "$(sed $1d $file)" > $file
    fi
}

<< "removeData()"
id=$( createListWindow )
status=$?
if [ $status -eq 0 ]
then
    index=$( dataIndex $id )
    removeData $index & update
fi
removeData()

createEntryWindow() {
    zenity --entry                     \
           --title        "URL Manager"\
           --text         ""           \
           --entry-text   "Enter Key"  \
           --cancel-label Quit         \
           --ok-label     Enter        \
           --extra-button Edit
}

openEditWindow() {
    value=$( createListWindow )
    status=$?

    if [ "$value" = "Add" ]
    then
        openAddWindow
    elif [ "$status" = "0" ]
    then
        index=$( dataIndex "$value" )
        removeData $index & update
    else
        openMainWindow
    fi
}

openURL() {
    local i=0
    for elem in "${data[@]}"
    do
        if [ $(($i % 4)) -eq 1 ]
        then
            url="$elem"
        elif [ $(($i % 4)) -eq 2 ]
        then
            if [ "${1^^}" = "${elem^^}" ]
            then
                xdg-open "$url"
            fi
        fi
        ((i++))
    done
}

openMainWindow() {
    value=$( createEntryWindow )
    status=$?

    if [ "$value" = "Edit" ]
    then
        openEditWindow
    elif [ $status -eq 0 ]
    then
        openURL "$value"
    fi
}

creatFormsWindow() {
    zenity --forms                  \
           --title     "URL Manager"\
	       --text      ""           \
           --separator "\" \""      \
           --add-entry URL          \
           --add-entry Key          \
           --add-entry Description
}

openAddWindow() {
    value=$( creatFormsWindow )
    status=$?

    if [ $status -eq 0 ]
    then
        addData "\"FALSE\" \"$value\" \\" & update
    else
        openEditWindow
    fi
}

if [ $1 = "updated" ]
then
    openEditWindow
else
    openMainWindow
fi
